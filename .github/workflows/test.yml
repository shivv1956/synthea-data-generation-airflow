name: CI Tests

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint pytest black flake8
      
      - name: Lint Python code
        run: |
          # Check code formatting
          black --check dags/ || echo "Code formatting issues found (non-blocking)"
          
          # Run flake8 for style guide
          flake8 dags/ --max-line-length=100 --ignore=E501,W503 || echo "Style issues found (non-blocking)"
      
      - name: Validate DAG syntax
        run: |
          python -c "import sys; sys.path.insert(0, 'dags'); from synthea_generation_dag import dag; print('✓ synthea_generation_dag.py is valid')"
          python -c "import sys; sys.path.insert(0, 'dags'); from s3_upload_dag import dag; print('✓ s3_upload_dag.py is valid')"
      
      - name: Check Docker Compose syntax
        run: |
          docker-compose config
      
      - name: Build Docker images
        run: |
          docker-compose build
      
      - name: Run integration tests
        run: |
          # Start services
          docker-compose up -d postgres
          
          # Wait for postgres to be ready
          sleep 10
          
          # Run tests
          # docker-compose run --rm airflow-scheduler pytest tests/
          
          # Cleanup
          docker-compose down -v
      
      - name: Security scan
        run: |
          # Scan for secrets in code
          echo "Running security checks..."
          # You can add tools like: trufflehog, gitleaks, etc.
          if grep -r "AKIA[0-9A-Z]{16}" --exclude-dir=.git --exclude="*.md" .; then
            echo "⚠️ Warning: Possible AWS credentials found in code"
            exit 1
          fi
